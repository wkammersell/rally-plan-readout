<!DOCTYPE html>
<html>
<head>
    <title>rally</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var app;Ext.define("CustomApp",{extend:"Rally.app.TimeboxScopedApp",scopeType:"release",componentCls:"app",launch:function(){app=this,app.firstLaunch=!0,app.callParent(arguments)},onScopeChange:function(scope){app.callParent(arguments),app._myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Fetching Your Plan ... Please wait."}),app._myMask.show();var myScope=app.getContext().getTimeboxScope().getRecord();app.fetchStories(myScope)},fetchStories:function(scope){console.log("Fetching Stories ...");var filters=[],releaseFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Release",operator:"=",value:scope.get("_ref")});filters.push(releaseFilter);var store=Ext.create("Rally.data.wsapi.Store",{model:"UserStory",fetch:["FormattedID","Name","Project","Feature"],context:app.getContext().getDataContext(),pageSize:2e3,limit:2e3},app);store.addFilter(filters,!1);var featureStoryMap={};featureStoryMap.Unaligned=[],store.loadPage(1,{scope:app,callback:function(records,operation){operation.wasSuccessful()&&(_.each(records,function(record){record.data.Feature?(void 0===featureStoryMap[record.data.Feature.FormattedID]&&(featureStoryMap[record.data.Feature.FormattedID]=[]),featureStoryMap[record.data.Feature.FormattedID].push(record.data)):featureStoryMap.Unaligned.push(record.data)},app),console.log("Feature Map"),console.log(featureStoryMap),app.fetchStoriedFeatures(scope,featureStoryMap))}})},fetchStoriedFeatures:function(scope,featureStoryMap){console.log("Fetching Storied Features ...");var subObjectiveFeatureMap={};subObjectiveFeatureMap.Unaligned=[],subObjectiveFeatureMap.Unaligned.push({Unaligned:featureStoryMap.Unaligned});var outStandingLoads=0;_.each(Object.keys(featureStoryMap),function(featureKey){console.log("Fetching "+featureKey+" ...");var filters=[],idFilter=Ext.create("Rally.data.wsapi.Filter",{property:"FormattedID",operator:"=",value:featureKey});filters.push(idFilter);var dataScope={workspace:this.getContext().getWorkspaceRef(),project:null},store=Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Feature",fetch:["FormattedID","Name","Project","Release","Parent"],context:dataScope,pageSize:2e3,limit:2e3},app);store.addFilter(filters,!1),outStandingLoads++,store.loadPage(1,{scope:app,callback:function(records,operation){if(operation.wasSuccessful()&&records.length>0){var record=records[0];console.log(record.data),record.data.stories=featureStoryMap[record.data.FormattedID],record.data.Parent?(void 0===subObjectiveFeatureMap[record.data.Parent.FormattedID]&&(subObjectiveFeatureMap[record.data.Parent.FormattedID]=[]),subObjectiveFeatureMap[record.data.Parent.FormattedID].push(record.data)):subObjectiveFeatureMap.Unaligned.push(record.data)}outStandingLoads--,0===outStandingLoads&&(console.log("Sub Objective Map"),console.log(subObjectiveFeatureMap),app.fetchFeaturedSubObjectives(scope,subObjectiveFeatureMap))}})},app)},fetchFeaturedSubObjectives:function(scope,subObjectiveFeatureMap){console.log("Fetching Featured Sub Objectives ...");var objectiveSubObjectiveMap={};objectiveSubObjectiveMap.Unaligned=[],objectiveSubObjectiveMap.Unaligned.push({Unaligned:subObjectiveFeatureMap.Unaligned});var outStandingLoads=0;_.each(Object.keys(subObjectiveFeatureMap),function(subObjectiveKey){console.log("Fetching "+subObjectiveKey+" ...");var filters=[],idFilter=Ext.create("Rally.data.wsapi.Filter",{property:"FormattedID",operator:"=",value:subObjectiveKey});filters.push(idFilter);var dataScope={workspace:this.getContext().getWorkspaceRef(),project:null},store=Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Initiative",fetch:["FormattedID","Name","Project","Parent"],context:dataScope,pageSize:2e3,limit:2e3},app);store.addFilter(filters,!1),outStandingLoads++,store.loadPage(1,{scope:app,callback:function(records,operation){if(operation.wasSuccessful()&&records.length>0){var record=records[0];console.log(record.data),record.data.features=subObjectiveFeatureMap[record.data.FormattedID],record.data.Parent?(void 0===objectiveSubObjectiveMap[record.data.Parent.FormattedID]&&(objectiveSubObjectiveMap[record.data.Parent.FormattedID]=[]),objectiveSubObjectiveMap[record.data.Parent.FormattedID].push(record.data)):objectiveSubObjectiveMap.Unaligned.push(record.data)}outStandingLoads--,0===outStandingLoads&&(console.log("Sub Objective Map"),console.log(objectiveSubObjectiveMap),app.fetchSubObjectivedObjectives(scope,objectiveSubObjectiveMap))}})},app)},fetchSubObjectivedObjectives:function(scope,objectiveSubObjectiveMap){console.log("Fetching Sub Objectived Objectives ...");var objectives=[];objectives.push(objectiveSubObjectiveMap.Unaligned);var outStandingLoads=0;_.each(Object.keys(objectiveSubObjectiveMap),function(objectiveKey){console.log("Fetching "+objectiveKey+" ...");var filters=[],idFilter=Ext.create("Rally.data.wsapi.Filter",{property:"FormattedID",operator:"=",value:objectiveKey});filters.push(idFilter);var dataScope={workspace:this.getContext().getWorkspaceRef(),project:null},store=Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Theme",fetch:["FormattedID","Name","Project"],context:dataScope,pageSize:2e3,limit:2e3},app);store.addFilter(filters,!1),outStandingLoads++,store.loadPage(1,{scope:app,callback:function(records,operation){if(operation.wasSuccessful()&&records.length>0){var record=records[0];console.log(record.data),record.data.subObjectives=objectiveSubObjectiveMap[record.data.FormattedID],objectives.push(record.data)}outStandingLoads--,0===outStandingLoads&&(console.log("Objectives"),console.log(objectives),app.displayPlan(objectives))}})},app)},clearContent:function(){for(;app.down("label");)app.down("label").destroy();for(;app.down("button");)app.down("button").destroy();for(;app.down("container");)app.down("container").destroy()},displayPlan:function(objectives){app.clearContent(),app._myMask.hide();var header=app.add({xtype:"container",border:0,layout:{type:"vbox",align:"stretch"},bodyStyle:{"background-color":"#00227b"}});header.add({xtype:"label",html:app.getContext().getProject().Name+" Plan for "+app.getContext().getTimeboxScope().getRecord().data.Name,style:{"font-size":"30px","background-color":"#00227b",color:"#FFFFFF","text-align":"center"}})}});

            Rally.launchApp('CustomApp', {
                name:"rally",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
