<!DOCTYPE html>
<html>
<head>
    <title>rally</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var app,UNALIGNED="Unaligned";Ext.define("CustomApp",{extend:"Rally.app.TimeboxScopedApp",scopeType:"release",componentCls:"app",launch:function(){app=this,app.callParent(arguments)},onScopeChange:function(scope){app.callParent(arguments),app._myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Fetching Your Plan ... Please wait ..."}),app._myMask.show();var myScope=app.getContext().getTimeboxScope().getRecord();app.fetchPlanWork(myScope,"UserStory")},fetchPlanWork:function(scope,model){console.log("Fetching plan "+model+" ...");var filters=[],releaseFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Release",operator:"=",value:scope.get("_ref")});filters.push(releaseFilter);var store=Ext.create("Rally.data.wsapi.Store",{model:"UserStory",fetch:["FormattedID","Name","Project","PortfolioItem"],context:app.getContext().getDataContext(),pageSize:2e3,limit:2e3},app);store.addFilter(filters,!1);var planMaps=[{}],planMap=planMaps[0],parentModel=null;planMap[UNALIGNED+model]=[],store.loadPage(1,{scope:app,callback:function(records,operation){operation.wasSuccessful()&&(_.each(records,function(record){if(record.data.PortfolioItem){var parentID=record.data.PortfolioItem.FormattedID;void 0===planMap[parentID]&&(planMap[parentID]=record.data.PortfolioItem,planMap[parentID].Children=[]),planMap[parentID].Children.push(record.data),parentModel=record.data.PortfolioItem._type}else planMap[UNALIGNED+model].push(record.data)},app),parentModel&&(planMap[UNALIGNED+model]._type=parentModel,console.log(planMaps),app.fetchPlanParent(scope,planMaps)))}})},fetchPlanParent:function(scope,planMaps){var model=planMaps[0][Object.keys(planMaps[0])[0]]._type;console.log("Fetching "+model+" ...");var currentMap=planMaps[0];planMaps.unshift({});var parentMap=planMaps[0];parentMap[UNALIGNED+model]=[];var outStandingLoads=0,parentModel=null;_.each(Object.keys(currentMap),function(key){console.log("Fetching "+key+" ...");var filters=[],idFilter=Ext.create("Rally.data.wsapi.Filter",{property:"FormattedID",operator:"=",value:key});filters.push(idFilter);var dataScope={workspace:this.getContext().getWorkspaceRef(),project:null},store=Ext.create("Rally.data.wsapi.Store",{model:model,fetch:["FormattedID","Name","Project","Release","Parent","Description"],context:dataScope,pageSize:2e3,limit:2e3},app);store.addFilter(filters,!1),outStandingLoads++,store.loadPage(1,{scope:app,callback:function(records,operation){if(operation.wasSuccessful()&&records.length>0){var record=records[0];if(currentMap[record.data.FormattedID]=Object.assign(currentMap[record.data.FormattedID],record.data),record.data.Parent){var parentID=record.data.Parent.FormattedID;void 0===parentMap[parentID]&&(parentMap[parentID]=record.data.Parent,parentMap[parentID].Children=[]),parentMap[parentID].Children.push(record.data),parentModel=record.data.Parent._type}else parentMap[UNALIGNED+model].push(record.data)}outStandingLoads--,0===outStandingLoads&&(console.log(planMaps),parentModel&&(parentMap[UNALIGNED+model]._type=parentModel,app.fetchPlanParent(scope,planMaps)))}})},app)},clearContent:function(){for(;app.down("label");)app.down("label").destroy();for(;app.down("button");)app.down("button").destroy();for(;app.down("container");)app.down("container").destroy()},displayPlan:function(objectives,objectiveIndex){app.clearContent();var objective=objectives[objectiveIndex];console.log(objective);var header=app.add({xtype:"container",border:0,layout:{type:"vbox",align:"stretch"},bodyStyle:{"background-color":"#00227b"}});header.add({xtype:"label",html:app.getContext().getProject().Name+" Plan for "+app.getContext().getTimeboxScope().getRecord().data.Name,style:{"font-size":"30px","background-color":"#00227b",color:"#FFFFFF","text-align":"left"}});var objectiveBody=app.add({xtype:"container",border:0,layout:{type:"vbox",align:"stretch"},bodyStyle:{"background-color":"#3949ab"}});objectiveBody.add({xtype:"label",html:"Our first objective is "+objective.FormattedID+" - "+objective.Name,style:{"font-size":"25px","background-color":"#3949ab",color:"#FFFFFF","text-align":"left"}}),objectiveBody.add({xtype:"label",html:objective.Description,style:{"font-size":"15px","background-color":"#ffffff",color:"#000000","text-align":"left"},height:"100px",autoScroll:!0});var subObjectivesBody=app.add({xtype:"container",border:0,layout:{type:"vbox",align:"stretch"},bodyStyle:{"background-color":"#6f74dd"},padding:"0 0 0 10"});subObjectivesBody.add({xtype:"label",html:"The short-term goals to achieve this objective are:",style:{"font-size":"25px","background-color":"#3949ab",color:"#FFFFFF","text-align":"left"}}),_.each(objective.subObjectives,function(subObjective){subObjectivesBody.add({xtype:"label",html:subObjective.FormattedID+" - "+subObjective.Name,style:{"font-size":"25px","background-color":"#6f74dd",color:"#FFFFFF","text-align":"left"}}),subObjectivesBody.add({xtype:"label",html:subObjective.Description,style:{"font-size":"15px","background-color":"#ffffff",color:"#000000","text-align":"left"},height:"100px",autoScroll:!0});var featuresContainer=subObjectivesBody.add({xtype:"container",border:0,layout:{type:"vbox",align:"stretch"},bodyStyle:{"background-color":"#aaaaaa"},padding:"0 0 0 10"});featuresContainer.add({xtype:"label",html:"To achieve this goal, we will implement:",style:{"font-size":"25px","background-color":"#aaaaaa",color:"#000000","text-align":"left"}}),_.each(subObjective.features,function(feature){featuresContainer.add({xtype:"label",html:feature.FormattedID+" - "+feature.Name,style:{"font-size":"25px","background-color":"#6f74dd",color:"#FFFFFF","text-align":"left"}}),featuresContainer.add({xtype:"label",html:feature.Description,style:{"font-size":"15px","background-color":"#ffffff",color:"#000000","text-align":"left"},height:"100px",autoScroll:!0})},app)},app)}});

            Rally.launchApp('CustomApp', {
                name:"rally",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
