<!DOCTYPE html>
<html>
<head>
    <title>rally</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var app,UNALIGNED="Unaligned";Ext.define("CustomApp",{extend:"Rally.app.TimeboxScopedApp",scopeType:"release",componentCls:"app",launch:function(){app=this,app.callParent(arguments)},onScopeChange:function(scope){app.callParent(arguments),app._myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Fetching Your Plan ... Please wait ..."}),app._myMask.show();var myScope=app.getContext().getTimeboxScope().getRecord();app.fetchPlanWork(myScope,"UserStory")},fetchPlanWork:function(scope,model){console.log("Fetching plan "+model+" ...");var filters=[],releaseFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Release",operator:"=",value:scope.get("_ref")});filters.push(releaseFilter);var store=Ext.create("Rally.data.wsapi.Store",{model:"UserStory",fetch:["FormattedID","Name","Project","PortfolioItem","DisplayColor","Description"],context:app.getContext().getDataContext(),pageSize:2e3,limit:2e3,sorters:[{property:"rank",direction:"DESC"}]},app);store.addFilter(filters,!1);var planMaps=[{}],planMap=planMaps[0],parentModel=null;planMap[UNALIGNED+model]=[],store.loadPage(1,{scope:app,callback:function(records,operation){operation.wasSuccessful()&&(_.each(records,function(record){if(record.data.PortfolioItem){var parentID=record.data.PortfolioItem.FormattedID;void 0===planMap[parentID]&&(planMap[parentID]=record.data.PortfolioItem,planMap[parentID].Children=[]),planMap[parentID].Children.push(record.data),parentModel=record.data.PortfolioItem._type}else planMap[UNALIGNED+model].push(record.data)},app),parentModel?(planMap[UNALIGNED+model]._type=parentModel,console.log(planMaps),app.fetchPlanParent(scope,planMaps)):app.displayPlan(planMaps,0))}})},fetchPlanParent:function(scope,planMaps){var model=planMaps[0][Object.keys(planMaps[0])[0]]._type;console.log("Fetching "+model+" ...");var currentMap=planMaps[0];planMaps.unshift({});var parentMap=planMaps[0];parentMap[UNALIGNED+model]=[];var outStandingLoads=0,parentModel=null;_.each(Object.keys(currentMap),function(key){console.log("Fetching "+key+" ...");var filters=[],idFilter=Ext.create("Rally.data.wsapi.Filter",{property:"FormattedID",operator:"=",value:key});filters.push(idFilter);var dataScope={workspace:this.getContext().getWorkspaceRef(),project:null},store=Ext.create("Rally.data.wsapi.Store",{model:model,fetch:["FormattedID","Name","Project","Parent","Description","DisplayColor"],context:dataScope,pageSize:2e3,limit:2e3},app);store.addFilter(filters,!1),outStandingLoads++,store.loadPage(1,{scope:app,callback:function(records,operation){if(operation.wasSuccessful()&&records.length>0){var record=records[0];if(currentMap[record.data.FormattedID].Name=record.data.Name,currentMap[record.data.FormattedID].Project=record.data.Project,currentMap[record.data.FormattedID].Parent=record.data.Parent,currentMap[record.data.FormattedID].Description=record.data.Description,currentMap[record.data.FormattedID].DisplayColor=record.data.DisplayColor,record.data.Parent){var parentID=record.data.Parent.FormattedID;void 0===parentMap[parentID]&&(parentMap[parentID]=record.data.Parent,parentMap[parentID].Children=[]),parentMap[parentID].Children.push(record.data),parentModel=record.data.Parent._type}else parentMap[UNALIGNED+model].push(record.data)}outStandingLoads--,0===outStandingLoads&&(console.log(planMaps),parentModel?(parentMap[UNALIGNED+model]._type=parentModel,app.fetchPlanParent(scope,planMaps)):app.displayPlan(planMaps,0))}})},app)},clearContent:function(){for(;app.down("label");)app.down("label").destroy();for(;app.down("button");)app.down("button").destroy();for(;app.down("container");)app.down("container").destroy()},displayPlan:function(planMaps,index){app._myMask.hide(),app.clearContent();var planItem=planMaps[0][Object.keys(planMaps[0])[0]][index];console.log(planItem);var header=app.add({xtype:"container",border:0,layout:{type:"vbox",align:"stretch"},bodyStyle:{"background-color":"#000000"}});header.add({xtype:"label",html:app.getContext().getProject().Name+" Plan for "+app.getContext().getTimeboxScope().getRecord().data.Name,padding:"0 0 0 10",style:{"font-size":"30px","background-color":"#000000",color:"#FFFFFF","text-align":"left"}});var model=planItem._type;model.indexOf("/")>=0&&(model=model.slice(model.indexOf("/")+1));var itemContainer=app.add({xtype:"container",border:0,layout:{type:"hbox",align:"stretch"},bodyStyle:{"background-color":"#000000"}});itemContainer.add({xtype:"label",flex:0,html:"___",style:{"font-size":"25px","background-color":planItem.DisplayColor,color:planItem.DisplayColor,"text-align":"left"}});var itemContentContainer=itemContainer.add({xtype:"container",flex:1,border:0,layout:{type:"vbox",align:"stretch"}}),itemTitleContainer=itemContentContainer.add({xtype:"container",flex:1,border:0,layout:{type:"hbox",align:"stretch"}});itemTitleContainer.add({xtype:"label",flex:1,html:"Our "+model+" ("+planItem.FormattedID+") "+planItem.Name,padding:"0 0 0 10",style:{"font-size":"25px","background-color":"#000000",color:"#FFFFFF","text-align":"left"}}),itemTitleContainer.add({xtype:"label",flex:1,html:" ( "+(index+1)+" of "+planMaps[0][Object.keys(planMaps[0])[0]].length+")",padding:"0 20 0 0",style:{"font-size":"25px","background-color":"#000000",color:"#FFFFFF","text-align":"right"}}),itemContentContainer.add({xtype:"label",html:planItem.Description,padding:"0 0 0 10",style:{"font-size":"15px","background-color":"#ffffff",color:"#000000","text-align":"left"},height:"200px",autoScroll:!0}),app.displayChildren(planItem,planMaps,1,itemContentContainer)},displayChildren:function(parent,planMaps,childDepth,container){container.add({xtype:"label",html:"To achieve this, we are planning:",padding:"0 0 0 10",flex:1,style:{"font-size":"25px","background-color":"#000000",color:"#FFFFFF","text-align":"left"}});var children=planMaps[childDepth][parent.FormattedID].Children;_.each(children,function(child){var childContainer=container.add({xtype:"container",border:0,layout:{type:"hbox",align:"stretch"},bodyStyle:{"background-color":"#000000"}});childContainer.add({xtype:"label",flex:0,html:"___",style:{"font-size":"25px","background-color":child.DisplayColor,color:child.DisplayColor,"text-align":"left"}});var childContentContainer=childContainer.add({xtype:"container",flex:1,border:0,layout:{type:"vbox",align:"stretch"}}),childTitleContainer=childContentContainer.add({xtype:"container",flex:1,border:0,layout:{type:"hbox",align:"stretch"}}),model=child._type;model.indexOf("/")>=0&&(model=model.slice(model.indexOf("/")+1)),childTitleContainer.add({xtype:"label",flex:1,html:"Our "+model+" ("+child.FormattedID+") "+child.Name,padding:"0 0 0 10",style:{"font-size":"25px","background-color":"#000000",color:"#FFFFFF","text-align":"left"}}),childContentContainer.add({xtype:"label",html:child.Description,padding:"0 0 0 10",style:{"font-size":"15px","background-color":"#ffffff",color:"#000000","text-align":"left"},height:"200px",autoScroll:!0}),childDepth<planMaps.length-1&&app.displayChildren(child,planMaps,childDepth+1,childContentContainer)},app)}});

            Rally.launchApp('CustomApp', {
                name:"rally",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
